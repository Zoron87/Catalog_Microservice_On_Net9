# docker compose --project-directory . -f deploy\docker-compose-prod.yaml up -d --build

services:
    catalog_db:
        container_name: catalog-db-prod
        image: postgres
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=12345678
            - POSTGRES_DB=catalog-db
        restart: always
        ports:
            - "7411:5432"
        volumes:
            - postgres_catalog:/var/lib/postgresql

    catalog_api:
        container_name: catalog-api
        build:
            context: .
            dockerfile: ./src/Services/Catalog/Catalog.API/Dockerfile
            args:
              - BUILDKIT_INLINE_CACHE=0
        ports:
          - "7301:8080"
        environment:
          - ASPNETCORE_ENVIRONMENT=Production
        depends_on:
            catalog_db:
                condition: service_started
            elasticsearch:
                condition: service_healthy
        restart: unless-stopped

# basket.api
    basket_db:
        container_name: basket-db-prod
        image: postgres
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=12345678
            - POSTGRES_DB=basket-db
        restart: always
        ports:
            - "7412:5432"
        volumes:
            - postgres_basket_prod:/var/lib/postgresql

    basket_redis:
        container_name: basket-redis-prod
        image: redis
        command: redis-server --requirepass "12345678" --protected-mode no
        restart: always
        ports:
            - "7422:6379"
        volumes:
            - redis_basket_prod:/data

    basket_api:
        container_name: basket-api
        build:
            context: .
            dockerfile: ./src/Services/Basket/Basket.API/Dockerfile
            args:
              - BUILDKIT_INLINE_CACHE=0
        ports:
          - "7302:8080"
        environment:
          - ASPNETCORE_ENVIRONMENT=Production
        depends_on:
          basket_db:
            condition: service_started
          basket_redis:
            condition: service_started
          promotion_api:
            condition: service_started
          rabbit_mq:
            condition: service_started
          elasticsearch:
            condition: service_healthy
        restart: unless-stopped

# promotion grpc
    promotion_db:
        container_name: promotion_db-prod
        image: mysql:8.0
        environment:
            - MYSQL_ROOT_PASSWORD=12345678
            - MYSQL_DATABASE=promotion-db
        restart: always
        ports:
            - "7403:3306"
        volumes:
            - mysql_promotion:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p12345678"]
            interval: 2s
            timeout: 2s
            retries: 10

    promotion_api:
        container_name: promotion-api
        build:
            context: .
            dockerfile: ./src/Services/Promotion/Promotion.Grpc/Dockerfile
            args:
              - BUILDKIT_INLINE_CACHE=0
        ports:
          - "7303:8080"
          - "7313:8081"
        environment:
          - ASPNETCORE_ENVIRONMENT=Production
        depends_on:
          promotion_db:
            condition: service_healthy
          elasticsearch:
            condition: service_healthy
        restart: unless-stopped

# Checkout api
    checkout_db:
        container_name: checkout-db-prod
        image: postgres
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=12345678
            - POSTGRES_DB=checkout-db
        ports:
          - "7404:5432"
        restart: always
        volumes:
            - postgres_checkout:/var/lib/postgresql
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 2s
            timeout: 2s
            retries: 10

    checkout_api:
        container_name: checkout-api
        build:
            context: .
            dockerfile: ./src/Services/Checkout/Checkout.API/Dockerfile
            args:
              - BUILDKIT_INLINE_CACHE=0
        ports:
          - "7304:8080"
        environment:
          - ASPNETCORE_ENVIRONMENT=Production
        depends_on:
          checkout_db:
            condition: service_healthy
          rabbit_mq:
            condition: service_healthy
          elasticsearch:
            condition: service_healthy
        restart: unless-stopped

# Rabbit Mq
    rabbit_mq:
        container_name: rabbit-mq-prod
        image: rabbitmq:3-management
        environment:
            - RABBITMQ_DEFAULT_USER=guest
            - RABBITMQ_DEFAULT_PASSWORD=guest
        ports:
          - "5672:5672"
          - "15672:15672"
        restart: always
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        healthcheck:
            test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
            interval: 10s
            timeout: 10s
            retries: 20

    elasticsearch:
        container_name: elasticsearch-prod
        image: elasticsearch:9.0.3
        environment:
          - node.name=elasticsearch-prod
          - cluster.name=es-docker-cluster-prod
          - discovery.type=single-node
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
          - xpack.security.enabled=false
          - xpack.security.enrollment.enabled=false
          - action.auto_create_index=true
          - cluster.routing.allocation.disk.threshold_enabled=false
        ulimits:
          memlock:
            soft: -1
            hard: -1
          nofile:
            soft: 65536
            hard: 65536
        volumes:
          - elasticsearch_data:/usr/share/elasticsearch/data
        ports:
          - "9200:9200"
        restart: always
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 5

    kibana:
        container_name: kibana-prod
        image: kibana:9.0.3
        environment:
          - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
          - SERVER_NAME=kibana-prod
          - SERVER_HOST=0.0.0.0
          - ELASTICSEARCH_USERNAME=
          - ELASTICSEARCH_PASSWORD=
        ports:
          - "5601:5601"
        depends_on:
          elasticsearch:
            condition: service_healthy
        restart: always

    prometheus:
        image: prom/prometheus
        volumes:
          - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
          - prometheus_data:/prometheus
        ports:
          - "9090:9090"

    grafana:
        image: grafana/grafana
        ports:
          - "3000:3000"
        environment:
          - GF_SECURITY_ADMIN_PASSWORD=admin
        volumes:
          - grafana_data:/var/lib/grafana

volumes:
    postgres_catalog:   
    postgres_basket_prod:
    redis_basket_prod:
    mysql_promotion:
    postgres_checkout:
    rabbitmq_data:
    elasticsearch_data:
    prometheus_data:
    grafana_data: